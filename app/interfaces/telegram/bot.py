# [file name]: bot.py
from telegram import Update
from telegram.ext import Application
from app.core.config import settings
from app.core.logger import log
from app.core.exceptions import TelegramBotException

from .handlers.base import setup_base_handlers
from .handlers.admin import setup_admin_handlers
from .handlers.conversations import setup_conversation_handlers


class VPNBot:
    """–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å Telegram –±–æ—Ç–∞"""

    def __init__(self):
        self.token = settings.telegram_token
        self.admin_id = settings.telegram_admin_id
        self.application: Application = None

    def setup(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞"""
        if not self.token:
            raise TelegramBotException("Telegram token –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏")

        self.application = Application.builder().token(self.token).build()
        self._setup_data()
        self._setup_handlers()
        log.info("‚úÖ Telegram –±–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω")

    def _setup_data(self):
        """–ü–æ–º–µ—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–æ—Ç–∞"""
        if not self.application:
            raise RuntimeError("Application –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

        self.application.bot_data["admin_id"] = self.admin_id

    def _setup_handlers(self):
        """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥"""
        if not self.application:
            raise RuntimeError("Application –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        setup_base_handlers(self.application, self.admin_id)
        setup_conversation_handlers(self.application, self.admin_id)
        setup_admin_handlers(self.application, self.admin_id)


        log.info("‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Telegram –±–æ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")

    def run(self):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ polling"""
        if not self.application:
            self.setup()

        log.info("üîÑ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞...")
        self.application.run_polling(allowed_updates=Update.ALL_TYPES)


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
vpn_bot = VPNBot()